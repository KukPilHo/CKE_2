<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>a.C.K.E. ë„êµ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .loader{border:4px solid #f3f3f3;border-radius:50%;border-top:4px solid #3498db;width:36px;height:36px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        pre{white-space:pre-wrap;word-wrap:break-word}
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background-color: #2563eb; 
            color: white; 
        }
    </style>
    <!-- ì›Œí¬ë¶ ìƒì„±ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ -->
    <script src="https://unpkg.com/pizzip@3.1.5/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.47.4/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">a.C.K.E. ë„êµ¬</h1>
            <p class="mt-2 text-gray-600">ì˜ì–´ í•™ìŠµì„ ìœ„í•œ ì›Œí¬ë¶ ìƒì„± ë° a.C.K.E. 4ë‹¨ê³„ ì‹œì—° ë„êµ¬</p>
        </header>

        <!-- íƒ­ ë²„íŠ¼ë“¤ -->
        <div class="flex justify-center mb-8">
            <button id="tab-workbook" class="tab-button active px-6 py-3 mx-2 rounded-lg font-semibold transition-colors bg-blue-600 text-white">
                ğŸ“š ì›Œí¬ë¶ ìƒì„±
            </button>
            <button id="tab-demo" class="tab-button px-6 py-3 mx-2 rounded-lg font-semibold transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¯ a.C.K.E. ë°ëª¨
            </button>
        </div>

        <!-- ì›Œí¬ë¶ ìƒì„± íƒ­ -->
        <div id="workbook-tab" class="tab-content active">
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-3">1. OpenAI API í‚¤</h2>
                <input type="password" id="apiKey" placeholder="sk-..." class="w-full p-3 border rounded-lg" />
                <p class="text-xs text-gray-500 mt-2">ë¸Œë¼ìš°ì € ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-3">2. ì˜ì–´ ì§€ë¬¸ ì…ë ¥</h2>
                <textarea id="inputText" rows="8" class="w-full p-3 border rounded-lg" placeholder="ì˜ì–´ ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <div class="text-center mb-8">
                <button id="runBtn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors">ì›Œí¬ë¶ ìƒì„±</button>
            </div>

            <div id="loading" class="hidden flex-col items-center my-8">
                <div class="loader"></div>
                <p class="mt-3 text-gray-600">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <div id="resultPanel" class="hidden bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-2">ìƒì„± ê²°ê³¼</h3>
                <p id="downloadArea" class="text-sm text-gray-700">ì›Œí¬ë¶ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- a.C.K.E. ë°ëª¨ íƒ­ -->
        <div id="demo-tab" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-3">1. OpenAI API í‚¤</h2>
                <input type="password" id="demoApiKey" placeholder="sk-..." class="w-full p-3 border rounded-lg" />
                <p class="text-xs text-gray-500 mt-2">ë¸Œë¼ìš°ì € ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-3">2. ì˜ì–´ ì§€ë¬¸ ì…ë ¥</h2>
                <textarea id="demoInputText" rows="8" class="w-full p-3 border rounded-lg" placeholder="ì˜ì–´ ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <div class="text-center mb-8">
                <button id="demoRunBtn" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors">a.C.K.E. 4ë‹¨ê³„ ì‹¤í–‰</button>
            </div>

            <div id="demoLoading" class="hidden flex-col items-center my-8">
                <div class="loader"></div>
                <p class="mt-3 text-gray-600">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <div id="demoResultPanel" class="hidden bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-2">a.C.K.E. 4ë‹¨ê³„ ê²°ê³¼</h3>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-blue-600">Step 1: Analyze (ë¶„ì„)</h4>
                        <pre id="step1-output" class="text-gray-700 leading-relaxed bg-gray-50 p-3 rounded"></pre>
                    </div>
                    <div>
                        <h4 class="font-semibold text-green-600">Step 2: Copy (ë³µì‚¬)</h4>
                        <pre id="step2-output" class="text-gray-700 leading-relaxed bg-gray-50 p-3 rounded"></pre>
                    </div>
                    <div>
                        <h4 class="font-semibold text-purple-600">Step 3: Korean (í•œêµ­ì–´ ë²ˆì—­)</h4>
                        <pre id="step3-output" class="text-gray-700 leading-relaxed bg-gray-50 p-3 rounded"></pre>
                    </div>
                    <div>
                        <h4 class="font-semibold text-orange-600">Step 4: English (ì˜ì–´ ì •ë ¬)</h4>
                        <pre id="step4-output" class="text-gray-700 leading-relaxed bg-gray-50 p-3 rounded"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë“¤ ë¡œë“œ -->
    <script src="step1-analyze.js"></script>
    <script src="step2-copy.js"></script>
    <script src="step3-korean.js"></script>
    <script src="step3-align.js"></script>
    <script src="step3-isolation.js"></script>

    <script>
        // íƒ­ ì „í™˜ ê¸°ëŠ¥
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë‚´ìš© ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('tab-' + tabName).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('tab-' + tabName).classList.add('bg-blue-600', 'text-white');
        }

        // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('tab-workbook').addEventListener('click', () => switchTab('workbook'));
        document.getElementById('tab-demo').addEventListener('click', () => switchTab('demo'));

        // ì›Œí¬ë¶ ìƒì„± ê¸°ëŠ¥
        (function(){
            const apiKeyInput = document.getElementById('apiKey');
            const inputText = document.getElementById('inputText');
            const runBtn = document.getElementById('runBtn');
            const loading = document.getElementById('loading');
            const resultPanel = document.getElementById('resultPanel');
            const downloadArea = document.getElementById('downloadArea');

            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) apiKeyInput.value = savedKey;
            apiKeyInput.addEventListener('input', ()=>{
                localStorage.setItem('openai_api_key', apiKeyInput.value);
            });

            async function callGpt(systemPrompt, userMessage){
                const key = apiKeyInput.value.trim();
                if (!key) throw new Error('OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                if (!key.startsWith('sk-')) throw new Error('ì˜¬ë°”ë¥¸ API í‚¤ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (sk-)');
                const API_URL = 'https://api.openai.com/v1/chat/completions';
                const body = {
                    model: 'gpt-4o',
                    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userMessage }],
                    temperature: 0.1,
                    seed: 12345
                };
                const resp = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify(body)
                });
                if (!resp.ok){
                    const err = await resp.json().catch(()=>({}));
                    throw new Error(err?.error?.message || 'OpenAI API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                const data = await resp.json();
                return data.choices[0].message.content.trim();
            }

            function ensureGlobals(){
                if (typeof step1Prompts === 'undefined') throw new Error('step1Prompts ë¡œë“œ ì‹¤íŒ¨');
                if (typeof step2Prompts === 'undefined') throw new Error('step2Prompts ë¡œë“œ ì‹¤íŒ¨');
                if (typeof isolationPrompts === 'undefined') throw new Error('isolationPrompts ë¡œë“œ ì‹¤íŒ¨');
            }

            function splitSentencesIntoGroups(text){
                const lines = text.split(/\r?\n/);
                const isSentenceTerminal = (t)=>(/[.!?][\)\]"'""]*$/.test((t||'').trim()));
                const groups=[]; let cur=[];
                for (const line of lines){
                    cur.push(line);
                    if (isSentenceTerminal(line)){ groups.push(cur); cur=[]; }
                }
                if (cur.length>0) groups.push(cur);
                return groups;
            }

            async function runPipeline(originalText){
                ensureGlobals();
                const analyze = originalText;
                const step2Prompt = `${step2Prompts.role}\n\n${step2Prompts.objective}\n\n${step2Prompts.absoluteRules}\n\n${step2Prompts.chunkingRules}\n\n${step2Prompts.learningCases}\n\n${step2Prompts.output}`;
                const copy = await callGpt(step2Prompt, originalText);
                const groups = splitSentencesIntoGroups(copy);
                const alignmentAvailable = typeof alignmentPrompts !== 'undefined';
                const isolationAvailable = typeof isolationPrompts !== 'undefined';
                const koreanLines = [];
                for (const group of groups){
                    const sentenceEN = group.join(' ').replace(/\s+/g,' ').trim();
                    let groupKO = [];
                    if (alignmentAvailable){
                        const prompt = `${alignmentPrompts.role}\n\n${alignmentPrompts.hardRules}\n\n${alignmentPrompts.guidance}\n\n${alignmentPrompts.example}\n\n${alignmentPrompts.output}`;
                        const userMsg = [
                            'ë‹¤ìŒì€ í•˜ë‚˜ì˜ ì˜ì–´ ë¬¸ì¥ê³¼, ê·¸ ë¬¸ì¥ì„ ì˜ë¯¸ë¡œ ë¶„í• í•œ Nê°œì˜ ì˜ì–´ ì¤„ì…ë‹ˆë‹¤.',
                            'ì˜ë¬¸ ë¬¸ì¥ì„ ë¨¼ì € í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´í•´í•œ ë’¤, Nê°œì˜ í•œêµ­ì–´ ì¤„ë¡œ ì¬ë¶„í•´í•˜ì—¬, ê° ì¤„ì´ ì…ë ¥ ì˜ì–´ ì¤„ê³¼ 1:1ë¡œ ì •í™•íˆ ëŒ€ì‘ë˜ë„ë¡ ë²ˆì—­í•˜ì„¸ìš”.',
                            '',
                            `Sentence (EN): ${sentenceEN}`,
                            `Lines (EN, N=${group.length}):`,
                            ...group,
                            '',
                            `ì¶œë ¥: í•œêµ­ì–´ ${group.length}ì¤„ (ì„¤ëª… ê¸ˆì§€, ê° ì¤„ì€ ì¤„ë°”ê¿ˆìœ¼ë¡œë§Œ êµ¬ë¶„)`
                        ].join('\n');
                        try{
                            const aligned = await callGpt(prompt, userMsg);
                            const alignedLines = aligned.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
                            if (alignedLines.length === group.length) groupKO = alignedLines;
                        }catch(e){ /* fallback */ }
                    }
                    if (groupKO.length === 0){
                        if (!isolationAvailable) throw new Error('isolation í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
                        const prompt = `${isolationPrompts.role}\n\n${isolationPrompts.absoluteRules}\n\n${isolationPrompts.examples}\n\n${isolationPrompts.output}`;
                        for (const line of group){
                            const userMsg = `ë‹¤ìŒ ì˜ì–´ ì¤„ë§Œ ë²ˆì—­í•˜ì„¸ìš”. ë‹¤ë¥¸ ì¤„ì€ ê³ ë ¤í•˜ì§€ ë§ˆì„¸ìš”:\n${line}`;
                            try{
                                const translated = await callGpt(prompt, userMsg);
                                groupKO.push(translated);
                            }catch(e){ groupKO.push(line); }
                        }
                    }
                    koreanLines.push(...groupKO);
                }
                const englishLines = copy;
                return { analyze, copy, korean: koreanLines.join('\n'), english: englishLines };
            }

            // DOCX ìƒì„±ì„ ìœ„í•œ ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
            function prepareDataForTemplate(analyzeText, copyText, koreanText, englishText, options = {}) {
                const padMode = options.padMode || 'nbsp'; 
                const targetCharsPerLine = Number(options.targetCharsPerLine || 400);
                
                const cleanAnalyzeText = (analyzeText || '').trim().replace(/\r?\n/g, ' ').replace(/\s+/g, ' ').trim();
                const copyLines = (copyText || '').trim().split(/\r?\n/).map(line => line.replace(/\r$/, '')).filter(line => line.trim() !== '');
                const koreanLines = (koreanText || '').trim().split(/\r?\n/).map(line => line.replace(/\r$/, '')).filter(line => line.trim() !== '');
                
                if (copyLines.length !== koreanLines.length) {
                    console.warn(`Warning: English lines (${copyLines.length}) and Korean lines (${koreanLines.length}) do not match.`);
                }
                
                const copyKoreanPairs = [];
                const maxLength = Math.min(copyLines.length, koreanLines.length);
                
                for (let i = 0; i < maxLength; i++) {
                    copyKoreanPairs.push({ en_line: copyLines[i], ko_line: koreanLines[i] });
                }
                
                const NBSP = '\u00A0';
                const englishSourceLines = (englishText && englishText.trim().length > 0)
                    ? englishText.trim().split(/\r?\n/).filter(line => line.trim() !== '')
                    : copyLines;
                const english_lines = englishSourceLines.map(line => ({ en_line: line }));
                const copy_lines = copyLines.map(line => ({ en_line: line }));
                const korean_lines = koreanLines.map(line => ({ ko_line: line }));

                if (padMode === 'underline' && targetCharsPerLine > 0) {
                    const padToLen = (text) => {
                        const base = (text || '').toString();
                        if (base.length >= targetCharsPerLine) return base;
                        return base + NBSP.repeat(targetCharsPerLine - base.length);
                    };
                    copyKoreanPairs.forEach(p => { p.en_line = padToLen(p.en_line); p.ko_line = padToLen(p.ko_line); });
                    copy_lines.forEach(o => { o.en_line = padToLen(o.en_line); });
                    korean_lines.forEach(o => { o.ko_line = padToLen(o.ko_line); });
                    english_lines.forEach(o => { o.en_line = padToLen(o.en_line); });
                }
                
                return {
                    analyze_text: cleanAnalyzeText,
                    copy_korean_pairs: copyKoreanPairs,
                    english_lines,
                    copy_lines,
                    korean_lines
                };
            }

            // ë¸Œë¼ìš°ì €ì—ì„œ DOCX ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            async function generateAndDownloadDocx(payload) {
                try {
                    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ìƒíƒœ í™•ì¸
                    if (typeof PizZip === 'undefined') {
                        throw new Error('PizZip ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    }
                    if (typeof docxtemplater === 'undefined') {
                        throw new Error('Docxtemplater ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    }
                    if (typeof saveAs === 'undefined') {
                        throw new Error('FileSaver ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    }

                    // 1. template.docx íŒŒì¼ì„ fetchë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                    const response = await fetch('template.docx');
                    if (!response.ok) throw new Error('template.docx íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    const content = await response.arrayBuffer();

                    // 2. Docxtemplater ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                    const zip = new PizZip(content);
                    const doc = new docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                    });

                    // 3. ë°ì´í„° ì¤€ë¹„
                    const { analyzeText, copyText, koreanText, englishText, options } = payload;
                    const templateData = prepareDataForTemplate(analyzeText, copyText, koreanText, englishText, options);

                    // 4. í…œí”Œë¦¿ì— ë°ì´í„° ì±„ìš°ê¸°
                    doc.render(templateData);

                    // 5. ê²°ê³¼ íŒŒì¼ì„ Blob í˜•íƒœë¡œ ìƒì„±
                    const out = doc.getZip().generate({
                        type: 'blob',
                        mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    });
                    
                    // 6. FileSaver.jsë¥¼ ì‚¬ìš©í•´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const outputFileName = `workbook_${timestamp}.docx`;
                    saveAs(out, outputFileName);
                    
                    resultPanel.classList.remove('hidden');
                    downloadArea.textContent = `${outputFileName} íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`;

                } catch (error) {
                    console.error('Error generating document:', error);
                    alert(`ì›Œí¬ë¶ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                }
            }

            runBtn.addEventListener('click', async ()=>{
                const text = inputText.value.trim();
                if (!text) { alert('ì˜ì–´ ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                runBtn.disabled = true; loading.classList.remove('hidden'); resultPanel.classList.add('hidden');
                downloadArea.innerHTML = '';
                try{
                    const { analyze, copy, korean, english } = await runPipeline(text);
                    
                    await generateAndDownloadDocx({
                        analyzeText: analyze,
                        copyText: copy,
                        koreanText: korean,
                        englishText: english,
                        options: { padMode: 'none' }
                    });

                }catch(e){
                    alert(e.message);
                }finally{
                    runBtn.disabled = false; loading.classList.add('hidden');
                }
            });
        })();

        // a.C.K.E. ë°ëª¨ ê¸°ëŠ¥
        (function(){
            const apiKeyInput = document.getElementById('demoApiKey');
            const inputText = document.getElementById('demoInputText');
            const runBtn = document.getElementById('demoRunBtn');
            const loading = document.getElementById('demoLoading');
            const resultPanel = document.getElementById('demoResultPanel');

            const savedKey = localStorage.getItem('demo_openai_api_key');
            if (savedKey) apiKeyInput.value = savedKey;
            apiKeyInput.addEventListener('input', ()=>{
                localStorage.setItem('demo_openai_api_key', apiKeyInput.value);
            });

            async function callGpt(systemPrompt, userMessage){
                const key = apiKeyInput.value.trim();
                if (!key) throw new Error('OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                if (!key.startsWith('sk-')) throw new Error('ì˜¬ë°”ë¥¸ API í‚¤ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (sk-)');
                const API_URL = 'https://api.openai.com/v1/chat/completions';
                const body = {
                    model: 'gpt-4o',
                    messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userMessage }],
                    temperature: 0.1,
                    seed: 12345
                };
                const resp = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify(body)
                });
                if (!resp.ok){
                    const err = await resp.json().catch(()=>({}));
                    throw new Error(err?.error?.message || 'OpenAI API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                const data = await resp.json();
                return data.choices[0].message.content.trim();
            }

            async function runDemo(text) {
                try {
                    // Step 1: Analyze - step1Prompts.role ì‚¬ìš©
                    if (!step1Prompts || !step1Prompts.role) {
                        throw new Error('Step 1 í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const step1Result = await callGpt(step1Prompts.role, text);
                    document.getElementById('step1-output').textContent = step1Result;

                    // Step 2: Copy
                    if (!step2Prompts || !step2Prompts.role) {
                        throw new Error('Step 2 í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const step2Prompt = `${step2Prompts.role}\n\n${step2Prompts.objective}\n\n${step2Prompts.absoluteRules}\n\n${step2Prompts.chunkingRules}\n\n${step2Prompts.learningCases}\n\n${step2Prompts.output}`;
                    const step2Result = await callGpt(step2Prompt, text);
                    document.getElementById('step2-output').textContent = step2Result;

                    // Step 3: Korean
                    if (!isolationPrompts || !isolationPrompts.role) {
                        throw new Error('Step 3 í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    const step3Prompt = `${isolationPrompts.role}\n\n${isolationPrompts.absoluteRules}\n\n${isolationPrompts.examples}\n\n${isolationPrompts.output}`;
                    const step3Result = await callGpt(step3Prompt, step2Result);
                    document.getElementById('step3-output').textContent = step3Result;

                    // Step 4: English alignment
                    if (typeof alignmentPrompts !== 'undefined') {
                        const step4Prompt = `${alignmentPrompts.role}\n\n${alignmentPrompts.hardRules}\n\n${alignmentPrompts.guidance}\n\n${alignmentPrompts.example}\n\n${alignmentPrompts.output}`;
                        const step4Result = await callGpt(step4Prompt, `ì˜ì–´: ${step2Result}\ní•œêµ­ì–´: ${step3Result}`);
                        document.getElementById('step4-output').textContent = step4Result;
                    } else {
                        document.getElementById('step4-output').textContent = "Alignment ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    }

                    resultPanel.classList.remove('hidden');
                } catch (error) {
                    alert(`ë°ëª¨ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                }
            }

            runBtn.addEventListener('click', async ()=>{
                const text = inputText.value.trim();
                if (!text) { alert('ì˜ì–´ ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                runBtn.disabled = true; loading.classList.remove('hidden'); resultPanel.classList.add('hidden');
                try{
                    await runDemo(text);
                }catch(e){
                    alert(e.message);
                }finally{
                    runBtn.disabled = false; loading.classList.add('hidden');
                }
            });
        })();
    </script>
</body>
</html>
